<html>
	<head>
		<script src="/socket.io/socket.io.js"></script>
		<script src="/js/underscore-min.js"></script>
		<script src="/js/jquery-2.0.2.min.js"></script>
		<script src="/js/backbone-min.js"></script>
		<script src="http://code.createjs.com/createjs-2013.05.14.min.js"></script>

    <style>
      #map {
        background-image:url("map.jpg");
      }
    </style>
	</head>
	<body>
		<ul id="players"></ul>
		<canvas id="map">
		</canvas>
		<script>
		  var socket = io.connect("/");

      var Player = Backbone.Model.extend({
        initialize: function() {
          var self = this;
          var circle = new createjs.Shape();
          circle.graphics
            .setStrokeStyle(3)
            .beginStroke(this.attributes.borderColor)
            .beginFill(this.attributes.color)
            .drawCircle(0, 0, 15);
          circle.x = this.attributes.x;
          circle.y = this.attributes.y;

          circle.onPress = function(e) {
            document.body.style.cursor='pointer';

            e.onMouseMove = function(ev) {
              e.target.x = ev.stageX;
              e.target.y = ev.stageY;
              socket.emit('player moved', self.attributes.id, playerId, ev.stageX, ev.stageY);
            };

            e.onMouseUp = function(ev) {
              socket.emit('player released', self.attributes.id);
            };
          };

          circle.onMouseOver = function(e) {
            document.body.style.cursor='pointer';
          };

          circle.onMouseOut = function(e) {
            document.body.style.cursor='default';
          }; 

          this.set('marker', circle);
        }
      });

      var playerId;
		  var players = [];
		  var canvas = new createjs.Stage('map');
      // poor naming choice
      canvas.canvas.onselectstart = function () { return false; }
      canvas.canvas.height = 1000;
      canvas.canvas.width = 1000;
      canvas.enableMouseOver(55);

		  var redrawPlayerList = function() {
		  	var playersList = $('#players');
		  	playersList.empty();
		  	
		  	players.forEach(function(player) {
          var playerLi = $('<li>', { text: player.get('name') });
          playerLi.css('color', player.get('color'));
		  		playersList.append(playerLi);
		  	});
		  };

		  socket.on("connect", function() {
		  	var name = prompt("Enter your character's name");
		  	socket.emit('player join', name);
		  });

      socket.on('set player id', function(id) {
        playerId = id;
      });

		  socket.on("player joined", function(player) {
        player = new Player(player);        

        players.push(player);
		  	
		    // TODO hook this up with an event
		    redrawPlayerList();

			  canvas.addChild(player.get('marker'));
		  });

		  socket.on("player left", function(playerThatLeft) {
        var player = _.find(players, function(p) {
          return p.id == playerThatLeft.id;
        });

		  	players = _.reject(players, function(p) {
		  		return p.id == playerThatLeft.id;
		  	});

		  	// TODO
		  	redrawPlayerList();

        canvas.removeChild(player.marker);
		  });

      socket.on("player updated", function(updatedPlayer) {
        var player = _.find(players, function(p) {
          return p.id == updatedPlayer.id;
        });

        player.get('marker').x = updatedPlayer.x;
        player.get('marker').y = updatedPlayer.y;
        player.set('borderColor', updatedPlayer.borderColor);
        player.get('marker').graphics.beginStroke(player.get('borderColor')).drawCircle(0, 0, 15);
      });

       
      function tick() { 
        canvas.update(); 
      } 

      setInterval(tick, 15); 
		</script>

	</body>
</html>
