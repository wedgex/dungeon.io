<html>
	<head>
		<script src="/socket.io/socket.io.js"></script>
		<script src="/js/underscore-min.js"></script>
		<script src="/js/jquery-2.0.2.min.js"></script>
		<script src="/js/fabric.min.js"></script>
	</head>
	<body>
		<ul id="players"></ul>
		<canvas id="map">
		</canvas>
		<script>
		  var socket = io.connect("/");
		  var players = [];
		  var canvas = new fabric.Canvas('map', { selection: false, hoverCursor: 'pointer'  });

		  var redrawPlayerList = function() {
		  	var playersList = $('#players');
		  	playersList.empty();
		  	
		  	players.forEach(function(player) {
		  		playersList.append($('<li>', { text: player.name }));
		  	});
		  };

		  socket.on("connect", function() {
		  	var name = prompt("Enter your character's name");
		  	socket.emit('player join', name);
		  });

		  socket.on("player joined", function(player) {
		  	player.marker = new fabric.Triangle({
				width: 30,
				height: 30,
				fill: player.color,
				left: 50,
				top: 50,
				angle: 180,
				strokeWidth: 5,
				stroke: 'black',
				hasControls: false,
				hasBorders: false
			});

			player.marker.on("moving", function(mark) {
				player.marker.stroke = player.color;
			});

			player.marker.on("modified", function(mark) {
				player.marker.stroke = 'black';
			});

		  	players.push(player);
		  	
		  	// TODO hook this up with an event
		  	redrawPlayerList();

			canvas.add(player.marker);
		  });

		  socket.on("player left", function(playerThatLeft) {
		  	players = _.reject(players, function(player) {
		  		return player.id == playerThatLeft.id;
		  	});

		  	// TODO
		  	redrawPlayerList();
		  });

		</script>

	</body>
</html>
